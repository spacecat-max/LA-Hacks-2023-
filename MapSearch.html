<!DOCTYPE html>
<html>

<!--
    website implimentation

    STAGE 1:
    user set location :)
    search nearby (get search nearby of all places) :)
    search nearby category restaurants
    remove points from unwanted places

    STAGE 2:
    categories button (get search POI category in nearby)
    remove unwanted points

    STAGE 3:
    pick a 2 cities
    subtract overlapping locations from one city (eg: etc)

-->

<head>
    <title>Map Search</title>
    <meta charset="utf-8" />

    <!-- Add references to the Azure Maps Map control JavaScript and CSS files. -->
    <link rel="stylesheet" href="https://atlas.microsoft.com/sdk/javascript/mapcontrol/2/atlas.min.css"
        type="text/css" />
    <script src="https://atlas.microsoft.com/sdk/javascript/mapcontrol/2/atlas.min.js"></script>

    <!-- Add a reference to the Azure Maps Services Module JavaScript file. -->
    <script src="https://atlas.microsoft.com/sdk/javascript/service/2/atlas-service.min.js"></script>

    <script>
        function GetMap() {
            //Add Map Control JavaScript code here
            //Instantiate a map object
            var map = new atlas.Map("myMap", {
                view: 'Auto',

                // Add your Azure Maps subscription key. https://aka.ms/am-primaryKey
                authOptions: {
                    authType: 'subscriptionKey',
                    subscriptionKey: '2au0lzNSBJtEx9IVTQ_8vJpUsH2yMKEdd8YFILxpybw'
                }
            });

            //Wait until the map resources are ready.
            map.events.add('ready', function () {

                //Create a data source and add it to the map.
                datasource = new atlas.source.DataSource();
                map.sources.add(datasource);

                //Add a layer for rendering point data.
                var resultLayer = new atlas.layer.SymbolLayer(datasource, null, {
                    iconOptions: {
                        image: 'pin-round-darkblue',
                        anchor: 'center',
                        allowOverlap: true
                    },
                    textOptions: {
                        anchor: "top"
                    }
                });

                map.layers.add(resultLayer);

                //Use MapControlCredential to share authentication between a map control and the service module.
                var pipeline = atlas.service.MapsURL.newPipeline(new atlas.service.MapControlCredential(map));

                // Construct the SearchURL object
                var searchURL = new atlas.service.SearchURL(pipeline);

                var query = 'restaurant'; // ************************************** TODO: locations here
                var radius = 9000;
                var lat = 47.64452336193245;  //**********************************************user location
                var lon = -122.13687658309935; //**********************************************user  location

                searchURL.searchPOI(atlas.service.Aborter.timeout(10000), query, {
                    limit: 10,
                    lat: lat,
                    lon: lon,
                    radius: radius,
                    view: 'Auto',
                }).then((results) => {

                    // Extract GeoJSON feature collection from the response and add it to the datasource
                    var data = results.geojson.getFeatures();
                    datasource.add(data);

                    // set camera to bounds to<Your Azure Maps Subscription Key> show the results
                    map.setCamera({
                        bounds: data.bbox,
                        zoom: 10,
                        padding: 15
                    });
                });

                // Create a popup but leave it closed so we can update it and display it later.
                popup = new atlas.Popup();

                //Add a mouse over event to the result layer and display a popup when this event fires.
                map.events.add('mouseover', resultLayer, showPopup);
                map.events.add('mouseout', resultLayer, hidePopup);

                //refresh the data on click
                map.events.add('click', function (e) {
                    //current coordinates 
                    var position = e.position;
                    console.log(position);

                    var query = 'restaurant'; // ************************************** TODO: locations here
                    var radius = 9000;
                    var lat = position[1];  //**********************************************user location
                    var lon = position[0]; //**********************************************user  location
                    var bounds = map.getCamera().bounds;

                    searchURL.searchPOI(atlas.service.Aborter.timeout(10000), query, {
                        limit: 10,
                        lat: lat,
                        lon: lon,
                        
                        /* 
                        FIX THIS LATER!!!!!!!!!!! VIEW BOUNDS
                        
                        topLeft: `${bounds[0]},${bounds[3]}`,
                        btmRight: `${bounds[2]},${bounds[1]}`, */
                        radius: radius,
                        view: 'Auto'
                    }).then((results) => {

                        // Extract GeoJSON feature collection from the response and add it to the datasource
                        var data = results.geojson.getFeatures();
                        datasource.clear();
                        datasource.add(data);


                        //console.log(data);
                        //console.log(map.getCamera().bounds); //top left (0,3) bottom right (1,2)
/* 
                        // set camera to bounds to<Your Azure Maps Subscription Key> show the results
                        map.setCamera({
                            bounds: data.bbox,
                            zoom: 10,
                            padding: 15
                        }); */
                    });

                });

                function hidePopup(e) {
                    popup.close(map);
                }
                function showPopup(e) {
                    //Get the properties and coordinates of the first shape that the event occurred on.
                    var p = e.shapes[0].getProperties();
                    var position = e.shapes[0].getCoordinates();

                    //Create HTML from properties of the selected result.
                    var html = `
                        <div style="padding:5px">
                        <div><b>${p.poi.name}</b></div>
                        <div>${p.address.freeformAddress}</div>
                        <div>${position[1]}, ${position[0]}</div>
                        </div>`;

                    //Update the content and position of the popup.
                    popup.setPopupOptions({
                        content: html,
                        position: position
                    });

                    //Open the popup.
                    popup.open(map);
                }
            });

        }

    </script>

    <style>
        html,
        body {
            width: 100%;
            height: 100%;
            padding: 0;
            margin: 0;
        }

        #myMap {
            width: 100%;
            height: 100%;
        }
    </style>
</head>

<body onload="GetMap()">
    <div id="myMap"></div>
</body>

</html>